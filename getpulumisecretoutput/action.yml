name: Get Pulumi Secret Output

description: Put a pulumi secret output into the environment
inputs:
  stack-name:
    description: The pulumi stack
    required: true
  infra-path:
      description: The path to the pulumi infra project
      required: false
      default: ./infra/
  pulumi-key:
      description: The Pulumi key
      required: true
  environment-variable:
      description: The Environment variable
      required: true      

runs:
  using: composite
  steps:
    - name: Retrieve ${{ inputs.pulumi-key }} secret into ${{ inputs.environment-variable }}
      run: |
            echo  "::add-mask::$(/usr/local/bin/pulumi stack output ${{ inputs.pulumi-key }} -s ${{ inputs.stack-name }} -C ${{ inputs.infra-path}} --non-interactive --show-secrets)"
            echo "${{ inputs.environment-variable }}=$(/usr/local/bin/pulumi stack output ${{ inputs.pulumi-key }} -s ${{ inputs.stack-name }} -C ${{ inputs.infra-path}}  --non-interactive --show-secrets)" >> $GITHUB_ENV
      shell: bash
